# Kademlia  KDT
    Kademlia 简称KDT。是一种分布式哈希表（DHT）技术。通过异或算法为距离度量基础，
    建立DHT拓扑结构。提高了路由查询速度。 BT 和 emule 基本上采用类似算法。

# 节点id 节点距离
    节点id是160bit位的随机数。 节点距离就是 两个节点id之间的异或结果。

# k桶
    一个比特位是一个桶。桶内记录距离本节点距离为 2 N-1次方 到 2 N次方的节点信息。
    理论上可以有160个桶。单都不会全部记录。比如选取8个桶。即只记录距离为256的节点
    内信息。超过这个范围的就不记录了。数据结构简单记为：
    桶1： [<ip,udp_port,node_id>,...<ip, udp_port,node_id>]
        LRU规则淘汰旧节点。
    桶N： [<ip,udp_port,node_id>,...<ip, udp_port,node_id>]
    
    桶数据更新：
    当收到新的节点信息时：
    1、new_node_id 和本节点的node_id 进行异或运行。计算出节点间的距离。
    2、根据两节点间的距离。计算出对应到那个桶中。注意如果距离大于允许记录的。直接抛弃
    3、如果新节点的信息已经在桶内。者把节点信息挪到尾部。
    4、如果节点信息不在桶内：
        a:如果桶内有容量，者直接把节点信息存储对应桶内的尾部
        b:如果桶内没有容量，就对头部节点进行探活检测（ping操作）。确认节点是否存活。
            如果节点存活。则把节点信息移动到尾部。丢弃新节点。
            如果节点不存活。则删除节点信息。把新的节点信息插入到桶的尾部。
    
    为了防止桶内数据老化（失效）。定期会无更新操作的桶，随机选取节点进行ping操作。检测
    节点是否存在。如不存在者删除。

    默认每个桶内可以保存20个节点。
    
    避免频繁更新桶内节点信息。研究表明。节点的失效概率和在线时长成反比。用户在线时间越
    长，继续在线的可能行越高。

# kademlia协议操作
    1、ping  探测节点是否在线
    2、store 通知一个节点存储一个<key,value>对 以便查询需要
    3、find_node 根据160位的节点id,返回本节点离目标节点最近的k个节点信息
        <ip, udp_port, node_id>. 可以从一个k桶中获得（k桶内节点多）或则多个k桶中
        获取（k桶内数据少）
    4、find_value。原理和find_node一样。不同的地方是只返回某个具体的节点信息。
       系统存储的数据以key,value对形式。
       BT系统中。key是torrent文件的info_hash串。value值为torrent相关信息。

# 路由查询机制 定位节点
    查找node_id为y的节点信息。 BT中alfa为3
    1、计算本节点和目标节点间的距离
    2、计算桶序号。并从桶内节点中找出离目标几点最近的alfa个节点。如果桶内数量小于alfa
       就从附近桶内找。对找出的alfa个几点。做find_node操作。如果有节点就是要找的。
       那直接返回本节点就是最接近目标节点。如果不是目标节点。则返回此节点距离目标几点
       最近的alfa个节点信息。
    3、本节点对接受到的alfa * alfa个节点。分别做find_node操作。直到有节点返回自己
      就是最接近目标节点。
# 定位资源
    定位资源整体逻辑和定位节点相识。不同点在于。调用的操作由find_node 变为了find_value

# 资源（key, value）存放过程
    1、发起者首先定位k个id值最近key的节点。
    2、发起者对这K个节点发起store操作。
    3、执行store操作的K个节点每小时重新发布自己所有的key,value对信息。
    4、所有key,value对信息有效期为24小时。

# 节点加入和离开
    加入：
    1、新节点需要一个种子节点B作为引导。并把该节点加入到本节点对应的K桶中。
    2、新节点随机生成一个节点ID。
    3、新节点向B发起find_node请求。请求定位的节点ID为本身。
    4、节点B收到find_node请求后。查找自己的已知的里新节点最近的K个几点返回给新节点。
    5、新节点收到B的返回后。逐个向K个返回结果的节点发送find_node（自己）的请求。直到
       新节点自己的路由表足够大为止。

