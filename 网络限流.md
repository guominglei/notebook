# 网络限流

## 固定时间窗口
    reids里定期Key。

## 滑动窗口
    
    解决跨固定时间窗口流量突发的问题。

## 令牌桶算法 token bucket
    
    限制平均速度。允许一定量的突发请求。

    假设流量限制在 N个每秒。会以 N分之一秒的频率，向令牌桶内添加一个令牌。
    如果令牌桶内数量大于N。本次添加操作不增加令牌数量。
    请求到来时，
        如果桶内有令牌。代表可以处理请求。转发一个请求。桶内可用令牌减少一个。 
        如果桶内没有令牌。代表不能处理请求。（本次请求可以抛弃、等待令牌到来、标记请求告诉后端处理程序本请求可以降低优先级处理。或者其他自己定义的处理方式）

    由于令牌桶可以容纳一定量的令牌。所以可以处理桶容量的突发请求。


### RFC 实现方式
#### 单速率三色标记
    
    采用双桶 C桶（正常流量）、E桶（突发流量）。 
    放令牌的时候，C桶满了的令牌放到E桶里。 E桶再满了抛弃令牌。
    取令牌的时候，当C桶没有令牌。使用E桶的。E桶再没有按设置好的抛弃策略。


### 双速率三色标记  
    
    C桶 E桶按不同速率放入令牌。


## 漏桶算法  leaky bucket
    
    强制限定了处理速度。平均和总量（上限）都限制了。

    假设流量限制在了N个每秒。 
    那么每N分之一秒从桶内取一个请求进行处理。桶可用容量增加1。桶内没有请求不做处理。
    假如请求到来时。桶里有容量。者进行等待操作。桶内没有容量。（请求抛弃）


## 分布式限流

### Redis令牌桶
    需要频繁网络开销。 生成令牌，消耗令牌 都需要网络消耗

### QPS 统一分配
    系统根据负载情况，按机器下发令牌桶容量。本地进行令牌桶算法

### 批发机制。
    本地服务。在令牌桶容量不够的情况下。去中央服务器获取一批令牌。进行下一步的消费使用。 减少了频繁获取令牌的网络开销。
